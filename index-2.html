<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevdokumentation - Dynamiskt System</title>
    <style>
        :root {
            --primary: #1b5aac; --secondary: #34a853; --success: #2ecc71;
            --warning: #f39c12; --danger: #e74c3c; --light: #f8f9fa;
            --dark: #34495e; --google-blue: #4285F4; --google-green: #34A853;
            --google-yellow: #FBBC05; --google-red: #EA4335;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        header { background: linear-gradient(135deg, var(--google-blue), var(--google-green)); color: white; padding: 25px; text-align: center; }
        h1 { margin-bottom: 10px; font-size: 2.2rem; }
        .header-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .header-controls label { font-weight: 500; }
        .header-controls select, .header-controls button { padding: 8px 12px; border-radius: 5px; border: 1px solid white; font-size: 1rem; }
        .header-controls select { background: rgba(255,255,255,0.2); color: white; }
        .header-controls select option { color: black; }
        .header-controls button { background: var(--google-yellow); color: white; cursor: pointer; border: none; }
        .content { padding: 30px; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media (max-width: 900px) { .content { grid-template-columns: 1fr; } }
        .student-list { background: var(--light); padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: fit-content; }
        .student-list h2 { margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; padding-bottom: 10px; border-bottom: 2px solid var(--google-blue); }
        .student-list h2 svg { margin-right: 10px; }
        .search-box { padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 20px; font-size: 1rem; }
        .student-item { padding: 12px 15px; margin-bottom: 8px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.3s; border-left: 4px solid transparent; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .student-item:hover { background: #e8f0fe; }
        .student-item.active { border-left-color: var(--google-blue); background: #e8f0fe; font-weight: bold; }
        .student-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.3s; }
        .student-item:hover .student-actions { opacity: 1; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 5px; }
        .completion-rate { font-size: 0.9rem; color: #666; background: #e9ecef; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
        .sheet-container { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .student-header { padding: 20px; background: var(--light); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; flex-wrap: wrap; gap: 10px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; padding: 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .summary-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .summary-card h3 { font-size: 1rem; margin-bottom: 10px; color: #666; }
        .summary-card .value { font-size: 1.8rem; font-weight: bold; }
        .summary-card.completed { border-top: 4px solid var(--google-green); }
        .summary-card.pending { border-top: 4px solid var(--google-yellow); }
        .summary-card.missing { border-top: 4px solid var(--google-red); }
        .sheet-header, .sheet-row { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr 1.5fr 100px; padding: 12px 15px; align-items: center; }
        .sheet-header { background: var(--google-blue); color: white; font-weight: bold; }
        .sheet-row { border-bottom: 1px solid #ddd; }
        .sheet-row:nth-child(even) { background: #f8f9fa; }
        .sheet-row:hover { background: #e6f4ea; }
        .status { font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .status.completed { color: var(--google-green); }
        .status.inprogress { color: var(--google-yellow); }
        .status.notstarted { color: var(--google-red); }
        .no-data { text-align: center; padding: 40px; color: #666; }
        .controls { display: flex; gap: 15px; padding: 20px; background: var(--light); border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--google-blue); color: white; }
        .btn-primary:hover { background-color: #3367d6; }
        .btn-secondary { background-color: white; color: var(--dark); border: 1px solid #ccc; }
        .btn-secondary:hover { background-color: #f0f0f0; }
        .btn-reminder { background-color: var(--google-green); color: white; }
        .activities-container { max-height: 50vh; overflow-y: auto; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .action-buttons { display: flex; gap: 5px; }
        
        /* Nya stilar för klassöversikt */
        .class-overview { display: none; padding: 20px; }
        .class-overview h2 { margin-bottom: 20px; color: var(--dark); padding-bottom: 10px; border-bottom: 2px solid var(--google-blue); }
        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .class-card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .class-card-header { background: var(--google-blue); color: white; padding: 15px; font-weight: bold; }
        .class-card-body { padding: 15px; }
        .class-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .class-stat { text-align: center; padding: 10px; border-radius: 6px; }
        .class-stat.completed { background-color: rgba(52, 168, 83, 0.1); color: var(--google-green); }
        .class-stat.pending { background-color: rgba(251, 188, 5, 0.1); color: var(--google-yellow); }
        .class-stat.missing { background-color: rgba(234, 67, 53, 0.1); color: var(--google-red); }
        .class-stat .value { font-size: 1.5rem; font-weight: bold; }
        .class-stat .label { font-size: 0.8rem; }
        .class-card-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .view-toggle { display: flex; margin-bottom: 20px; }
        .view-toggle-btn { padding: 10px 20px; background: #f0f0f0; border: none; cursor: pointer; }
        .view-toggle-btn.active { background: var(--google-blue); color: white; }
        .view-toggle-btn:first-child { border-radius: 4px 0 0 4px; }
        .view-toggle-btn:last-child { border-radius: 0 4px 4px 0; }
        .google-classroom-btn { background-color: var(--google-blue); color: white; }
        .course-management { margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Elevdokumentation</h1>
            <div class="header-controls">
                <label for="classSelector">Välj klass:</label>
                <select id="classSelector"></select>
                <button id="addClassBtn">Ny klass</button>
                <button id="importGoogleClassroomBtn">Importera från Google Classroom</button>
                <button id="manageCoursesBtn">Hantera kurser</button>
            </div>
        </header>
        
        <div class="view-toggle">
            <button class="view-toggle-btn active" id="classViewBtn">Klassöversikt</button>
            <button class="view-toggle-btn" id="studentViewBtn">Elevvy</button>
        </div>
        
        <div class="content">
            <div class="class-overview" id="classOverview">
                <h2>Klassöversikt: <span id="currentClassName"></span></h2>
                <div class="class-grid" id="classGrid"></div>
            </div>
            
            <div class="student-list" id="studentListView">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Elever
                </h2>
                <input type="text" class="search-box" id="searchStudent" placeholder="Sök elev...">
                <div id="studentListContainer"></div>
                <button class="btn btn-primary" id="addStudentBtn" style="width: 100%; margin-top: 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Lägg till elev
                </button>
            </div>
            
            <div class="sheet-container">
                <div class="student-header">
                    <h2 id="selectedStudentName">Välj en klass och en elev</h2>
                </div>
                
                <div id="studentDataView">
                     <div class="no-data" id="initialMessage">
                        <p>Välj en elev från listan för att se deras aktiviteter.</p>
                    </div>

                    <div id="activitiesContainer" style="display: none;">
                        <div class="summary-cards">
                            <div class="summary-card completed">
                                <h3>Avklarade</h3>
                                <div class="value" id="completedCount">0</div>
                            </div>
                            <div class="summary-card pending">
                                <h3>Pågående</h3>
                                <div class="value" id="pendingCount">0</div>
                            </div>
                            <div class="summary-card missing">
                                <h3>Ej påbörjade</h3>
                                <div class="value" id="missingCount">0</div>
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="btn btn-primary" id="addActivityBtn">Lägg till aktivitet</button>
                            <button class="btn btn-reminder" id="reminderBtn">Skicka påminnelse</button>
                            <button class="btn google-classroom-btn" id="linkToGoogleClassroomBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 3a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3H6a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3V6a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3h12a3 3 0 0 0 3-3 3 3 0 0 0-3-3z"></path></svg>
                                Länka till Google Classroom
                            </button>
                        </div>
                        
                        <div class="sheet-header">
                            <div>Aktivitet</div><div>Typ</div><div>Deadline</div><div>Status</div><div>Betyg</div><div>Kommentar</div><div>Åtgärd</div>
                        </div>
                        <div class="activities-container">
                            <div id="activitiesBody"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentModalTitle">Lägg till elev</h2>
                <span class="close" data-modal="studentModal">&times;</span>
            </div>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label for="studentName">Elevens namn</label>
                    <input type="text" id="studentName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="studentEmail">E-post (för påminnelser)</label>
                    <input type="email" id="studentEmail" class="form-control">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-btn" data-modal="studentModal">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Spara</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="activityModalTitle">Lägg till aktivitet</h2>
                <span class="close" data-modal="activityModal">&times;</span>
            </div>
            <form id="activityForm">
                <input type="hidden" id="activityId">
                <div class="form-group">
                    <label for="activityName">Aktivitetens namn</label>
                    <input type="text" id="activityName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="activityType">Typ</label>
                    <input type="text" id="activityType" class="form-control" placeholder="T.ex. Inlämning, Prov...">
                </div>
                <div class="form-group">
                    <label for="activityDeadline">Deadline</label>
                    <input type="date" id="activityDeadline" class="form-control">
                </div>
                <div class="form-group">
                    <label for="activityStatus">Status</label>
                    <select id="activityStatus" class="form-control">
                        <option value="notstarted">Ej påbörjad</option>
                        <option value="inprogress">Pågående</option>
                        <option value="completed">Avklarad</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="activityGrade">Betyg/Poäng</label>
                    <input type="text" id="activityGrade" class="form-control">
                </div>
                <div class="form-group">
                    <label for="activityComment">Kommentar</label>
                    <textarea id="activityComment" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-btn" data-modal="activityModal">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Spara</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="courseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hantera kurser</h2>
                <span class="close" data-modal="courseModal">&times;</span>
            </div>
            <div class="course-management">
                <h3>Befintliga kurser</h3>
                <div id="courseList"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary close-btn" data-modal="courseModal">Stäng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STRUCTURE & STATE ---
            let appData = {
                currentClass: null,
                classes: {},
                courses: {},
                currentView: 'class' // 'class' or 'student'
            };

            let selectedStudentId = null;

            // --- DOM ELEMENTS ---
            const classSelector = document.getElementById('classSelector');
            const addClassBtn = document.getElementById('addClassBtn');
            const importGoogleClassroomBtn = document.getElementById('importGoogleClassroomBtn');
            const manageCoursesBtn = document.getElementById('manageCoursesBtn');
            const studentListContainer = document.getElementById('studentListContainer');
            const searchStudentInput = document.getElementById('searchStudent');
            const addStudentBtn = document.getElementById('addStudentBtn');
            const selectedStudentName = document.getElementById('selectedStudentName');
            const initialMessage = document.getElementById('initialMessage');
            const activitiesContainer = document.getElementById('activitiesContainer');
            const activitiesBody = document.getElementById('activitiesBody');
            const addActivityBtn = document.getElementById('addActivityBtn');
            const reminderBtn = document.getElementById('reminderBtn');
            const linkToGoogleClassroomBtn = document.getElementById('linkToGoogleClassroomBtn');
            const classViewBtn = document.getElementById('classViewBtn');
            const studentViewBtn = document.getElementById('studentViewBtn');
            const classOverview = document.getElementById('classOverview');
            const studentListView = document.getElementById('studentListView');
            const classGrid = document.getElementById('classGrid');
            const currentClassName = document.getElementById('currentClassName');
            
            // Summary Cards
            const completedCountEl = document.getElementById('completedCount');
            const pendingCountEl = document.getElementById('pendingCount');
            const missingCountEl = document.getElementById('missingCount');

            // Modals
            const studentModal = document.getElementById('studentModal');
            const activityModal = document.getElementById('activityModal');
            const courseModal = document.getElementById('courseModal');
            const studentForm = document.getElementById('studentForm');
            const activityForm = document.getElementById('activityForm');
            const courseList = document.getElementById('courseList');
            
            // --- DATA PERSISTENCE ---
            function saveData() {
                localStorage.setItem('studentTrackerData', JSON.stringify(appData));
            }

            function loadData() {
                const data = localStorage.getItem('studentTrackerData');
                if (data) {
                    appData = JSON.parse(data);
                } else {
                    // Create default data if none exists
                    appData = {
                        currentClass: 'Exempelklass',
                        classes: {
                            'Exempelklass': {
                                students: [
                                    { id: 1, name: "Anna Andersson", email: "anna@example.com" },
                                    { id: 2, name: "Erik Eriksson", email: "erik@example.com" },
                                ],
                                activities: {
                                    1: [ { id: 101, name: "Uppgift 1", type: "Inlämning", deadline: "2025-09-15", status: "completed", grade: "A", comment: "Bra jobbat!" } ],
                                    2: [ { id: 102, name: "Uppgift 1", type: "Inlämning", deadline: "2025-09-15", status: "notstarted", grade: "", comment: "" } ],
                                }
                            }
                        },
                        courses: {
                            'Matematik': { color: '#4285F4' },
                            'Svenska': { color: '#34A853' },
                            'Engelska': { color: '#FBBC05' }
                        }
                    };
                }
            }
            
            // --- RENDERING FUNCTIONS ---
            function renderAll() {
                renderClassSelector();
                renderStudentList();
                renderStudentActivities();
                renderClassOverview();
                updateView();
            }

            function renderClassSelector() {
                classSelector.innerHTML = '';
                if (Object.keys(appData.classes).length === 0) {
                     classSelector.innerHTML = '<option>Inga klasser</option>';
                     return;
                }
                for (const className in appData.classes) {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    if (className === appData.currentClass) {
                        option.selected = true;
                    }
                    classSelector.appendChild(option);
                }
            }

            function renderStudentList() {
                studentListContainer.innerHTML = '';
                if (!appData.currentClass || !appData.classes[appData.currentClass]) {
                    studentListContainer.innerHTML = '<p>Välj eller skapa en klass.</p>';
                    return;
                }
                
                const students = appData.classes[appData.currentClass].students || [];
                const searchTerm = searchStudentInput.value.toLowerCase();
                const filteredStudents = students.filter(s => s.name.toLowerCase().includes(searchTerm));

                if (filteredStudents.length === 0) {
                     studentListContainer.innerHTML = '<p>Inga elever hittades.</p>';
                     return;
                }

                filteredStudents.forEach(student => {
                    const studentActivities = appData.classes[appData.currentClass].activities[student.id] || [];
                    const completedCount = studentActivities.filter(a => a.status === 'completed').length;
                    const totalCount = studentActivities.length;

                    const item = document.createElement('div');
                    item.className = 'student-item';
                    item.dataset.id = student.id;
                    if (student.id === selectedStudentId) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div style="flex-grow: 1;">
                            <div>${student.name}</div>
                        </div>
                        <div class="completion-rate">${completedCount}/${totalCount}</div>
                        <div class="student-actions">
                            <button class="btn-icon edit-student-btn" title="Redigera elev">✏️</button>
                            <button class="btn-icon delete-student-btn" title="Ta bort elev">🗑️</button>
                        </div>
                    `;
                    studentListContainer.appendChild(item);
                });
            }

            function renderStudentActivities() {
                if (!selectedStudentId) {
                    selectedStudentName.textContent = 'Välj en elev';
                    initialMessage.style.display = 'block';
                    activitiesContainer.style.display = 'none';
                    return;
                }

                const student = appData.classes[appData.currentClass].students.find(s => s.id === selectedStudentId);
                if (!student) {
                    selectedStudentId = null;
                    renderStudentActivities();
                    return;
                }

                selectedStudentName.textContent = `Aktiviteter för ${student.name}`;
                initialMessage.style.display = 'none';
                activitiesContainer.style.display = 'block';

                const activities = appData.classes[appData.currentClass].activities[selectedStudentId] || [];
                activitiesBody.innerHTML = '';

                // Update summary
                completedCountEl.textContent = activities.filter(a => a.status === 'completed').length;
                pendingCountEl.textContent = activities.filter(a => a.status === 'inprogress').length;
                missingCountEl.textContent = activities.filter(a => a.status === 'notstarted').length;
                
                if (activities.length === 0) {
                    activitiesBody.innerHTML = `<div class="no-data">Inga aktiviteter för denna elev.</div>`;
                    return;
                }
                
                activities.forEach(act => {
                    const row = document.createElement('div');
                    row.className = 'sheet-row';
                    
                    const statusMap = {
                        completed: { text: 'Avklarad', icon: '✔️' },
                        inprogress: { text: 'Pågående', icon: '⏳' },
                        notstarted: { text: 'Ej påbörjad', icon: '❌' }
                    };

                    row.innerHTML = `
                        <div>${act.name || ''}</div>
                        <div>${act.type || ''}</div>
                        <div>${act.deadline || ''}</div>
                        <div class="status ${act.status}">${statusMap[act.status].icon} ${statusMap[act.status].text}</div>
                        <div>${act.grade || '–'}</div>
                        <div>${act.comment || '–'}</div>
                        <div class="action-buttons">
                            <button class="btn-icon edit-activity-btn" data-id="${act.id}" title="Redigera aktivitet">✏️</button>
                            <button class="btn-icon delete-activity-btn" data-id="${act.id}" title="Ta bort aktivitet">🗑️</button>
                        </div>
                    `;
                    activitiesBody.appendChild(row);
                });
            }
            
            function renderClassOverview() {
                if (!appData.currentClass || !appData.classes[appData.currentClass]) {
                    classGrid.innerHTML = '<p>Välj eller skapa en klass.</p>';
                    return;
                }
                
                currentClassName.textContent = appData.currentClass;
                classGrid.innerHTML = '';
                
                const students = appData.classes[appData.currentClass].students || [];
                
                if (students.length === 0) {
                    classGrid.innerHTML = '<p>Inga elever i denna klass.</p>';
                    return;
                }
                
                // Calculate class-wide statistics
                let totalCompleted = 0;
                let totalPending = 0;
                let totalMissing = 0;
                let totalActivities = 0;
                
                students.forEach(student => {
                    const activities = appData.classes[appData.currentClass].activities[student.id] || [];
                    totalCompleted += activities.filter(a => a.status === 'completed').length;
                    totalPending += activities.filter(a => a.status === 'inprogress').length;
                    totalMissing += activities.filter(a => a.status === 'notstarted').length;
                    totalActivities += activities.length;
                });
                
                // Create class summary card
                const summaryCard = document.createElement('div');
                summaryCard.className = 'class-card';
                summaryCard.innerHTML = `
                    <div class="class-card-header">Klasssammanfattning</div>
                    <div class="class-card-body">
                        <div class="class-stats">
                            <div class="class-stat completed">
                                <div class="value">${totalCompleted}</div>
                                <div class="label">Avklarade</div>
                            </div>
                            <div class="class-stat pending">
                                <div class="value">${totalPending}</div>
                                <div class="label">Pågående</div>
                            </div>
                            <div class="class-stat missing">
                                <div class="value">${totalMissing}</div>
                                <div class="label">Ej påbörjade</div>
                            </div>
                        </div>
                        <div class="class-card-actions">
                            <button class="btn btn-primary view-class-btn">Visa alla elever</button>
                        </div>
                    </div>
                `;
                classGrid.appendChild(summaryCard);
                
                // Create student cards
                students.forEach(student => {
                    const studentActivities = appData.classes[appData.currentClass].activities[student.id] || [];
                    const completed = studentActivities.filter(a => a.status === 'completed').length;
                    const pending = studentActivities.filter(a => a.status === 'inprogress').length;
                    const missing = studentActivities.filter(a => a.status === 'notstarted').length;
                    const total = studentActivities.length;
                    
                    const card = document.createElement('div');
                    card.className = 'class-card';
                    card.innerHTML = `
                        <div class="class-card-header">${student.name}</div>
                        <div class="class-card-body">
                            <div class="class-stats">
                                <div class="class-stat completed">
                                    <div class="value">${completed}</div>
                                    <div class="label">Avklarade</div>
                                </div>
                                <div class="class-stat pending">
                                    <div class="value">${pending}</div>
                                    <div class="label">Pågående</div>
                                </div>
                                <div class="class-stat missing">
                                    <div class="value">${missing}</div>
                                    <div class="label">Ej påbörjade</div>
                                </div>
                            </div>
                            <div class="class-card-actions">
                                <button class="btn btn-primary view-student-btn" data-id="${student.id}">Visa detaljer</button>
                            </div>
                        </div>
                    `;
                    classGrid.appendChild(card);
                });
            }
            
            function renderCourseList() {
                courseList.innerHTML = '';
                for (const courseName in appData.courses) {
                    const courseItem = document.createElement('div');
                    courseItem.className = 'student-item';
                    courseItem.innerHTML = `
                        <div>${courseName}</div>
                        <div class="student-actions">
                            <button class="btn-icon delete-course-btn" data-course="${courseName}" title="Ta bort kurs">🗑️</button>
                        </div>
                    `;
                    courseList.appendChild(courseItem);
                }
                
                // Add option to add new course
                const addCourseItem = document.createElement('div');
                addCourseItem.className = 'student-item';
                addCourseItem.innerHTML = `
                    <input type="text" id="newCourseName" class="form-control" placeholder="Ny kursnamn" style="margin-right: 10px;">
                    <button class="btn btn-primary" id="addCourseBtn">Lägg till kurs</button>
                `;
                courseList.appendChild(addCourseItem);
            }
            
            function updateView() {
                if (appData.currentView === 'class') {
                    classOverview.style.display = 'block';
                    studentListView.style.display = 'none';
                    classViewBtn.classList.add('active');
                    studentViewBtn.classList.remove('active');
                } else {
                    classOverview.style.display = 'none';
                    studentListView.style.display = 'block';
                    classViewBtn.classList.remove('active');
                    studentViewBtn.classList.add('active');
                }
            }
            
            // --- EVENT LISTENERS & LOGIC ---

            // Class Management
            addClassBtn.addEventListener('click', () => {
                const className = prompt('Ange namn för den nya klassen:');
                if (className && !appData.classes[className]) {
                    appData.classes[className] = { students: [], activities: {} };
                    appData.currentClass = className;
                    selectedStudentId = null;
                    saveData();
                    renderAll();
                } else if (className) {
                    alert('En klass med detta namn finns redan.');
                }
            });

            classSelector.addEventListener('change', (e) => {
                appData.currentClass = e.target.value;
                selectedStudentId = null;
                saveData();
                renderAll();
            });

            // Student Management
            studentListContainer.addEventListener('click', (e) => {
                const studentItem = e.target.closest('.student-item');
                if (!studentItem) return;
                
                const studentId = parseInt(studentItem.dataset.id);
                
                if (e.target.closest('.edit-student-btn')) {
                    openStudentModal(studentId);
                } else if (e.target.closest('.delete-student-btn')) {
                    if (confirm('Är du säker på att du vill ta bort denna elev och all tillhörande data?')) {
                        deleteStudent(studentId);
                    }
                } else {
                    selectedStudentId = studentId;
                    appData.currentView = 'student';
                    renderStudentList();
                    renderStudentActivities();
                    updateView();
                }
            });

            addStudentBtn.addEventListener('click', () => openStudentModal());

            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(studentForm.studentId.value);
                const name = studentForm.studentName.value;
                const email = studentForm.studentEmail.value;

                if (id) { // Update existing
                    const student = appData.classes[appData.currentClass].students.find(s => s.id === id);
                    student.name = name;
                    student.email = email;
                } else { // Add new
                    const newId = Date.now();
                    appData.classes[appData.currentClass].students.push({ id: newId, name, email });
                    appData.classes[appData.currentClass].activities[newId] = [];
                }
                saveData();
                renderStudentList();
                renderClassOverview();
                closeModal('studentModal');
            });
            
            // Activity Management
            addActivityBtn.addEventListener('click', () => {
                if (!selectedStudentId) {
                    alert('Välj en elev först.');
                    return;
                }
                openActivityModal();
            });
            
            activitiesBody.addEventListener('click', e => {
                 if (e.target.closest('.edit-activity-btn')) {
                    const activityId = parseInt(e.target.closest('.edit-activity-btn').dataset.id);
                    openActivityModal(activityId);
                } else if (e.target.closest('.delete-activity-btn')) {
                    const activityId = parseInt(e.target.closest('.delete-activity-btn').dataset.id);
                    if (confirm('Är du säker på att du vill ta bort denna aktivitet?')) {
                        deleteActivity(activityId);
                    }
                }
            });

            activityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const studentActivities = appData.classes[appData.currentClass].activities[selectedStudentId];
                const id = parseInt(activityForm.activityId.value);
                const activityData = {
                    name: activityForm.activityName.value,
                    type: activityForm.activityType.value,
                    deadline: activityForm.activityDeadline.value,
                    status: activityForm.activityStatus.value,
                    grade: activityForm.activityGrade.value,
                    comment: activityForm.activityComment.value
                };
                
                if(id) { // Update
                    const index = studentActivities.findIndex(a => a.id === id);
                    studentActivities[index] = { ...studentActivities[index], ...activityData };
                } else { // Add new
                    activityData.id = Date.now();
                    studentActivities.push(activityData);
                }
                saveData();
                renderStudentActivities();
                renderStudentList(); // To update completion rate
                renderClassOverview(); // Update class overview
                closeModal('activityModal');
            });

            // View Toggle
            classViewBtn.addEventListener('click', () => {
                appData.currentView = 'class';
                updateView();
            });
            
            studentViewBtn.addEventListener('click', () => {
                appData.currentView = 'student';
                updateView();
            });
            
            // Class Overview Interactions
            classGrid.addEventListener('click', (e) => {
                if (e.target.closest('.view-student-btn')) {
                    const studentId = parseInt(e.target.closest('.view-student-btn').dataset.id);
                    selectedStudentId = studentId;
                    appData.currentView = 'student';
                    renderStudentList();
                    renderStudentActivities();
                    updateView();
                } else if (e.target.closest('.view-class-btn')) {
                    appData.currentView = 'student';
                    updateView();
                }
            });
            
            // Google Classroom Integration
            importGoogleClassroomBtn.addEventListener('click', () => {
                alert('Google Classroom-integration skulle här ansluta till Google Classroom API för att importera klasser och elever. Denna funktion kräver en serverkomponent för autentisering.');
                
                // Simulerad import (ersätt med riktig API-integration)
                const className = prompt('Ange namn på klassen att importera:');
                if (className) {
                    if (!appData.classes[className]) {
                        appData.classes[className] = { students: [], activities: {} };
                    }
                    
                    // Lägg till några exemelelever
                    appData.classes[className].students.push(
                        { id: Date.now() + 1, name: "Google Elev 1", email: "elev1@example.com" },
                        { id: Date.now() + 2, name: "Google Elev 2", email: "elev2@example.com" }
                    );
                    
                    appData.currentClass = className;
                    saveData();
                    renderAll();
                    alert('Klass importerad från Google Classroom (simulerad)');
                }
            });
            
            linkToGoogleClassroomBtn.addEventListener('click', () => {
                if (!selectedStudentId) {
                    alert('Välj en elev först.');
                    return;
                }
                alert('Länka till Google Classroom-funktion skulle här öppna en dialog för att länka elevens aktiviteter till Google Classroom-uppgifter. Denna funktion kräver en serverkomponent för autentisering.');
            });
            
            // Course Management
            manageCoursesBtn.addEventListener('click', () => {
                renderCourseList();
                courseModal.style.display = 'flex';
            });
            
            courseList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-course-btn')) {
                    const courseName = e.target.closest('.delete-course-btn').dataset.course;
                    if (confirm(`Är du säker på att du vill ta bort kursen "${courseName}"?`)) {
                        delete appData.courses[courseName];
                        saveData();
                        renderCourseList();
                    }
                }
            });
            
            document.getElementById('addCourseBtn').addEventListener('click', () => {
                const courseName = document.getElementById('newCourseName').value;
                if (courseName && !appData.courses[courseName]) {
                    appData.courses[courseName] = { color: '#' + Math.floor(Math.random()*16777215).toString(16) };
                    saveData();
                    renderCourseList();
                    document.getElementById('newCourseName').value = '';
                } else if (courseName) {
                    alert('En kurs med detta namn finns redan.');
                }
            });

            // Other
            searchStudentInput.addEventListener('input', renderStudentList);
            
            reminderBtn.addEventListener('click', () => {
                if(!selectedStudentId) return;
                const student = appData.classes[appData.currentClass].students.find(s => s.id === selectedStudentId);
                if(!student || !student.email) {
                    alert('Eleven saknar en e-postadress. Redigera eleven för att lägga till en.');
                    return;
                }
                
                const notStarted = (appData.classes[appData.currentClass].activities[selectedStudentId] || []).filter(a => a.status === 'notstarted');
                
                if(notStarted.length === 0) {
                    alert('Eleven har inga ej påbörjade uppgifter.');
                    return;
                }
                
                const subject = `Påminnelse om uppgifter i ${appData.currentClass}`;
                let body = `Hej ${student.name},\n\nDetta är en påminnelse om följande ej påbörjade uppgifter:\n\n`;
                notStarted.forEach(a => {
                    body += `- ${a.name} (deadline: ${a.deadline || 'ej satt'})\n`;
                });
                body += `\nVänliga hälsningar,\nDin lärare`;
                
                window.location.href = `mailto:${student.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            });

            // --- HELPER & MODAL FUNCTIONS ---
            function openStudentModal(id = null) {
                studentForm.reset();
                if (id) {
                    const student = appData.classes[appData.currentClass].students.find(s => s.id === id);
                    document.getElementById('studentModalTitle').textContent = 'Redigera elev';
                    studentForm.studentId.value = student.id;
                    studentForm.studentName.value = student.name;
                    studentForm.studentEmail.value = student.email;
                } else {
                    document.getElementById('studentModalTitle').textContent = 'Lägg till elev';
                }
                studentModal.style.display = 'flex';
            }
            
            function openActivityModal(id = null) {
                activityForm.reset();
                if (id) {
                     const activity = appData.classes[appData.currentClass].activities[selectedStudentId].find(a => a.id === id);
                     document.getElementById('activityModalTitle').textContent = 'Redigera aktivitet';
                     activityForm.activityId.value = activity.id;
                     activityForm.activityName.value = activity.name;
                     activityForm.activityType.value = activity.type;
                     activityForm.activityDeadline.value = activity.deadline;
                     activityForm.activityStatus.value = activity.status;
                     activityForm.activityGrade.value = activity.grade;
                     activityForm.activityComment.value = activity.comment;
                } else {
                     document.getElementById('activityModalTitle').textContent = 'Lägg till aktivitet';
                }
                 activityModal.style.display = 'flex';
            }

            function deleteStudent(id) {
                let students = appData.classes[appData.currentClass].students;
                appData.classes[appData.currentClass].students = students.filter(s => s.id !== id);
                delete appData.classes[appData.currentClass].activities[id];
                if (selectedStudentId === id) {
                    selectedStudentId = null;
                }
                saveData();
                renderStudentList();
                renderStudentActivities();
                renderClassOverview();
            }

            function deleteActivity(id) {
                let activities = appData.classes[appData.currentClass].activities[selectedStudentId];
                appData.classes[appData.currentClass].activities[selectedStudentId] = activities.filter(a => a.id !== id);
                saveData();
                renderStudentActivities();
                renderStudentList();
                renderClassOverview();
            }
            
            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            document.querySelectorAll('.close, .close-btn').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.modal));
            });

            window.addEventListener('click', e => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });
            
            // --- INITIALIZATION ---
            loadData();
            renderAll();
        });
    </script>
</body>
</html>